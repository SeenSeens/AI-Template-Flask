{% extends 'admin/layout/base.html' %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
{% include 'admin/components/breadcrumb.html' %}

<div class="container-fluid">
    <div class="mb-4">
        <div style="width: 250px;">
            {{ form.type(class="form-select", id="selectedType") }}
            {% if form.type.errors %}
                <div class="text-danger">{{ form.type.errors[0] }}</div>
            {% endif %}
        </div>
        <h2>Danh s√°ch preset</h2>
        {% if presets %}
        <div id="preset-wrapper" style="display: none;">
            <table class="table table-bordered table-sm" id="preset-table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Use Case</th>
                    <th>Temperature</th>
                    <th>Top P</th>
                    <th>Max Tokens</th>
                    <th>Default</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for preset in presets %}
                <tr data-type="{{ preset.type }}">
                    <td>{{ loop.index }}</td>
                    <td>{{ preset.use_case }}</td>
                    <td>{{ preset.temperature }}</td>
                    <td>{{ preset.top_p }}</td>
                    <td>{{ preset.max_tokens }}</td>
                    <td>{% if preset.is_default %}‚úÖ{% endif %}</td>
                    <td>
                        <div class="d-flex order-actions">
                        <a href="" class="text-primary"><i class="lni lni-eye"></i></a>
                        <a href="" class="mx-2 text-warning"><i class="bx bxs-edit"></i></a>
                        <a href="#" class="delete-term text-danger" data-id="{{ preset.id }}"><i class="bx bxs-trash"></i></a>
                    </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        <div id="preset-empty" class="alert alert-info">Ch∆∞a c√≥ preset n√†o ƒë∆∞·ª£c l∆∞u.</div>
        {% endif %}
    </div>

    <form method="POST" action="{{ url_for('admin.config_content_ai') }}">
        {{ form.hidden_tag() }}
        <h2 class="mb-4">‚öôÔ∏è C·∫•u h√¨nh AI cho vi·∫øt n·ªôi dung</h2>
        <div class="row">
            <div class="mb-3 col-12 col-md-6">
                {{ form.use_case.label(class="form-label", for="use_case") }}
                {{ form.use_case(class="form-control", placeholder="v√≠ d·ª•: V√≠ d·ª•: blog-writing, seo-copy, email-campaign") }}
                {% if form.use_case.errors %}
                    <div class="text-danger">{{ form.use_case.errors[0] }}</div>
                {% endif %}
            </div>
            <!-- Preset l·ª±a ch·ªçn ho·∫∑c t·∫°o m·ªõi -->
            <div class="mb-3 col-12 col-md-6">
                {{ form.type.label(class="form-label", for="type") }}
                {{ form.type(class="form-select") }}
                {% if form.type.errors %}
                    <div class="text-danger">{{ form.type.errors[0] }}</div>
                {% endif %}
            </div>
        </div>
        <!-- Tham s·ªë model -->
        <div class="row">
            <div class="col-md-4">
                {{ form.temperature.label(class="form-label", for="temperature") }}
                {{ form.temperature(class="form-control") }}
                {% if form.temperature.errors %}
                    <div class="text-danger">{{ form.temperature.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="col-md-4">
                {{ form.top_p.label(class="form-label", for="top_p") }}
                {{ form.top_p(class="form-control") }}
                {% if form.top_p.errors %}
                    <div class="text-danger">{{ form.top_p.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="col-md-4">
                {{ form.max_tokens.label(class="form-label", for="max_tokens") }}
                {{ form.max_tokens(class="form-control") }}
                {% if form.max_tokens.errors %}
                    <div class="text-danger">{{ form.max_tokens.errors[0] }}</div>
                {% endif %}
            </div>
        </div>
        <div class="mt-3 mb-3">
            {{ form.frequency_penalty.label(class="form-label", for="frequency_penalty") }}
            {{ form.frequency_penalty(class="form-control") }}
            {% if form.frequency_penalty.errors %}
                <div class="text-danger">{{ form.frequency_penalty.errors[0] }}</div>
            {% endif %}
        </div>
        <!-- T√≠nh nƒÉng -->
        <fieldset class="border p-3 mb-3">
            <legend class="w-auto px-2">üß† T√≠nh nƒÉng h·ªó tr·ª£</legend>
            <div class="form-check">
                {{ form.autocomplete(class="form-check-input", id="autocomplete") }}
                {{ form.autocomplete.label(class="form-label", for="autocomplete") }}
                {% if form.autocomplete.errors %}
                    <div class="text-danger">{{ form.autocomplete.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="form-check">
                {{ form.summarize(class="form-check-input", id="summarize") }}
                {{ form.summarize.label(class="form-label", for="summarize") }}
                {% if form.summarize.errors %}
                    <div class="text-danger">{{ form.summarize.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="form-check">
                {{ form.translate(class="form-check-input", id="translate") }}
                {{ form.translate.label(class="form-label", for="translate") }}
                {% if form.translate.errors %}
                    <div class="text-danger">{{ form.translate.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="form-check">
                {{ form.multi_chat(class="form-check-input", id="multi_chat") }}
                {{ form.multi_chat.label(class="form-label", for="multi_chat") }}
                {% if form.multi_chat.errors %}
                    <div class="text-danger">{{ form.multi_chat.errors[0] }}</div>
                {% endif %}
            </div>
            <div class="form-check">
                {{ form.is_default(class="form-check-input", id="is_default") }}
                {{ form.is_default.label(class="form-label", for="is_default") }}
                {% if form.is_default.errors %}
                    <div class="text-danger">{{ form.is_default.errors[0] }}</div>
                {% endif %}
            </div>
        </fieldset>
        <!-- JSON m·ªü r·ªông -->
        <div class="mb-3">
            {{ form.features.label(class="form-label", for="features") }}
            {{ form.features }}
            {% if form.features.errors %}
                <div class="text-danger">{{ form.features.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="mt-4">
            <button type="submit" class="btn btn-primary">üíæ L∆∞u c·∫•u h√¨nh</button>
            <a href="" class="btn btn-secondary">Quay l·∫°i</a>
        </div>
    </form>

    <div class="mt-5">
        <h2>üìù Ki·ªÉm tra t·∫°o n·ªôi dung b·∫±ng AI (Gemini)</h2>
        <form id="ai-content-form" method="post">
             <!-- CSRF Token t·ª´ Flask -->
            <input type="hidden" id="csrf_token" name="csrf_token" value="{{ csrf_token() }}">
            <!-- Provider (OpenAI, Gemini, Anthropic, HuggingFace) -->
            <div class="mb-3">
                <label for="provider-select" class="form-label">Ch·ªçn nh√† cung c·∫•p AI</label>
                <select class="form-select" id="provider-select" name="provider">
                    <option value="">-- Ch·ªçn provider --</option>
                    <option value="gemini">Gemini (Google)</option>
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic</option>
                    <option value="huggingface">Hugging Face</option>
                </select>
                <label for="preset-select">Ch·ªçn preset</label>
                <select class="form-select" id="preset-select">
                    <option value="">-- Ch·ªçn preset --</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="prompt" class="form-label">Ch·ªß ƒë·ªÅ / Y√™u c·∫ßu</label>
                <textarea class="form-control" id="prompt" name="prompt" rows="4" placeholder="VD: Vi·∫øt m·ªôt b√†i blog gi·ªõi thi·ªáu v·ªÅ AI trong gi√°o d·ª•c..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">‚ö° T·∫°o n·ªôi dung</button>
        </form>

        <div class="mt-4" id="result-box" style="display:none;">
            <h5>K·∫øt qu·∫£:</h5>
            <div id="result-content" class="border rounded p-3 bg-light"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
'use strict'
class AiContentGenerator {
    constructor() {
        this.providerSelect = document.getElementById("provider-select");
        this.presetSelect = document.getElementById("preset-select");
        this.promptInput = document.getElementById("prompt");
        this.csrfToken = document.getElementById("csrf_token").value;
        this.form = document.getElementById("ai-content-form");
        this.resultBox = document.getElementById("result-box");
        this.resultContent = document.getElementById("result-content");

        this.init();
    }

    init() {
        this.providerSelect.addEventListener("change", () => this.loadPresets());
        this.form.addEventListener("submit", (e) => this.handleSubmit(e));
    }

    async loadPresets() {
        const provider = this.providerSelect.value;
        this.presetSelect.innerHTML = `<option value="">-- ƒêang t·∫£i preset... --</option>`;

        if (!provider) {
            this.presetSelect.innerHTML = `<option value="">-- Ch·ªçn preset --</option>`;
            return;
        }

        try {
            const response = await axios.post(
                "/admin/load-presets",
                { provider },
                {
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": this.csrfToken
                    }
                }
            );

            const presets = response.data.presets || [];
            this.presetSelect.innerHTML = `<option value="">-- Ch·ªçn preset --</option>`;

            if (presets.length === 0) {
                this.presetSelect.innerHTML += `<option disabled>Kh√¥ng c√≥ preset ph√π h·ª£p</option>`;
            } else {
                presets.forEach(preset => {
                    const option = document.createElement("option");
                    option.value = preset.id;
                    option.textContent = preset.use_case;
                    this.presetSelect.appendChild(option);
                });
            }
        } catch (err) {
            console.error("L·ªói khi t·∫£i preset:", err);
            this.presetSelect.innerHTML = `<option value="">-- L·ªói t·∫£i preset --</option>`;
        }
    }

    async handleSubmit(e) {
        e.preventDefault();

        const prompt = this.promptInput.value;
        const provider = this.providerSelect.value;
        const preset = this.presetSelect.value;

        if (!prompt) {
            this.showResult("‚ö†Ô∏è Vui l√≤ng nh·∫≠p y√™u c·∫ßu n·ªôi dung.");
            return;
        }

        if (!provider || !preset) {
            this.showResult("‚ö†Ô∏è Vui l√≤ng ch·ªçn nh√† cung c·∫•p v√† preset.");
            return;
        }

        this.resultBox.style.display = "none";
        this.resultContent.innerHTML = "‚è≥ ƒêang t·∫°o n·ªôi dung...";

        try {
            const res = await axios.post(
                "/admin/generate-ai-post",
                {
                    prompt,
                    provider,
                    preset
                },
                {
                    headers: {
                        "X-CSRFToken": this.csrfToken,
                        "Content-Type": "application/json"
                    }
                }
            );

            const result = res.data?.content || "‚ö†Ô∏è Kh√¥ng c√≥ n·ªôi dung tr·∫£ v·ªÅ.";
            this.showResult(result);
        } catch (err) {
            const errorMsg = err.response?.data?.error || "‚ùå ƒê√£ x·∫£y ra l·ªói khi sinh n·ªôi dung.";
            this.showResult(errorMsg);
        }
    }

    showResult(message) {
        this.resultContent.innerHTML = message;
        this.resultBox.style.display = "block";
    }
}

// Kh·ªüi t·∫°o khi DOM ƒë√£ s·∫µn s√†ng
document.addEventListener("DOMContentLoaded", function () {
    new AiContentGenerator();
});

</script>
{% endblock %}
