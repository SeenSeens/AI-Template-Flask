{% extends 'admin/layout/base.html' %}
{% block title %}{{ page_title }}{% endblock %}
{% block content %}
{% include 'admin/components/breadcrumb.html' %}
<div class="container-fluid">
    <form class="row gy-3" method="post" action="{{ url_for('admin.ai_configuration') }}">
         {{ form.csrf_token }}
        <!-- API Token -->
        <div class="col-12">
            {{ form.token.label(class="form-label") }}
            {{ form.token(class="form-control", placeholder="Nh·∫≠p token API‚Ä¶") }}
        </div>
        <!-- Provider -->
        <div class="col-md-6">
            {{ form.provider.label(class="form-label") }}
            {{ form.provider(class="form-select") }}
        </div>
        <!-- Task (ch·ªâ hi·ªÉn th·ªã khi Hugging Face) -->
        <div class="col-md-6" id="task-wrapper" style="display:none">
            {{ form.task_type.label(class="form-label") }}
            {{ form.task_type(class="form-select") }}
        </div>
        <!-- Model -->
        <div class="col-md-6">
            {{ form.model_name.label(class="form-label") }}
            {{ form.model_name(class="form-select") }}
        </div>
        <div class="col-12 text-end">
            <button type="submit" class="btn btn-sm btn-primary">üíæ L∆∞u c·∫•u h√¨nh</button>
            <button type="button" id="btn-test-connection" class="btn btn-sm btn-success" data-action="test">üß™ Ki·ªÉm tra k·∫øt n·ªëi</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}

<script>
document.addEventListener("DOMContentLoaded", function () {
    const tokenInput = document.getElementById("token");
    const providerSelect = document.getElementById("provider");
    const modelSelect = document.getElementById("model_name");
    const taskSelect = document.getElementById("task_type");

    async function fetchModels() {
        const token = tokenInput.value.trim();
        const provider = providerSelect.value.trim();
        const task = taskSelect?.value?.trim();

        if (!token || !provider) {
            alert("Vui l√≤ng nh·∫≠p token v√† ch·ªçn provider.");
            return;
        }

        const payload = {
            token: token,
            provider: provider
        };
        if (provider === "huggingface" && task) {
            payload.task = task;
        }

        try {
            const response = await fetch("/admin/load-models", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });

            const text = await response.text();

            try {
                data = JSON.parse(text); // parse th·ª≠
            } catch (parseError) {
                throw new Error("Server kh√¥ng tr·∫£ v·ªÅ JSON: " + text.slice(0, 100));
            }
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || "Kh√¥ng th·ªÉ load models.");
            }

            const data = await response.json();
            const models = data.models || [];

            modelSelect.innerHTML = "";
            models.forEach(model => {
                const option = document.createElement("option");
                option.value = model.id;
                option.textContent = model.label;
                modelSelect.appendChild(option);
            });

        } catch (err) {
            console.error("‚ùå Fetch error:", err);
            alert(err.message || "ƒê√£ x·∫£y ra l·ªói khi t·∫£i models.");
        }
    }

    tokenInput.addEventListener("blur", fetchModels);
    providerSelect.addEventListener("change", fetchModels);
});
</script>



{% endblock %}