{% extends 'admin/layout/base.html' %}
{% block title %}C·∫•u h√¨nh AI{% endblock %}
{% block content %}
<!--breadcrumb-->
<div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
    <div class="ps-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 p-0">
                <li class="breadcrumb-item"><a href="javascript:;"><i class="bx bx-home-alt"></i></a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">C·∫•u h√¨nh AI</li>
            </ol>
        </nav>
    </div>
</div>
<!--end breadcrumb-->
<h6 class="mb-0 ps-3 text-uppercase">C·∫•u h√¨nh AI</h6>
<hr/>
<div class="container-fluid">
    <form class="row gy-3" method="post" action="{{ url_for('admin.ai_configuration') }}">
         {{ form_helper.csrf_token }}
        <!-- API Token -->
        <div class="col-12">
            {{ form_helper.token.label(class="form-label") }}
            {{ form_helper.token(class="form-control", placeholder="Nh·∫≠p token API‚Ä¶") }}
        </div>
        <!-- Provider -->
        <div class="col-md-6">
            {{ form_helper.provider.label(class="form-label") }}
            {{ form_helper.provider(class="form-select") }}
        </div>
        <!-- Task (ch·ªâ hi·ªÉn th·ªã khi Hugging Face) -->
        <div class="col-md-6" id="task-wrapper" style="display:none">
            {{ form_helper.task_type.label(class="form-label") }}
            {{ form_helper.task_type(class="form-select") }}
        </div>

        <!-- Model -->
        <div class="col-md-6">
            {{ form_helper.model_name.label(class="form-label") }}
            {{ form_helper.model_name(class="form-select") }}
        </div>
        <!-- Parameters -->
        <div class="col-md-3">
            {{ form_helper.temperature.label(class="form-label") }}
            {{ form_helper.temperature(class="form-control", step="0.1", min="0", max="1", type="number") }}
            {% if form_helper.temperature.errors %}
                <div class="text-danger">
                    {{ form_helper.temperature.errors[0] }}
                </div>
            {% endif %}
        </div>
        <div class="col-md-3">
            {{ form_helper.max_tokens.label(class="form-label") }}
            {{ form_helper.max_tokens(class="form-control", type="number") }}
            {% if form_helper.max_tokens.errors %}
                <div class="text-danger">
                    {{ form_helper.max_tokens.errors[0] }}
                </div>
            {% endif %}
        </div>
        <div class="col-md-3">
            {{ form_helper.top_p.label(class="form-label") }}
            {{ form_helper.top_p(class="form-control", step="0.1", min="0", max="1", type="number") }}
            {% if form_helper.top_p.errors %}
                <div class="text-danger">
                    {{ form_helper.top_p.errors[0] }}
                </div>
            {% endif %}
        </div>
        <div class="col-md-3">
            {{ form_helper.frequency_penalty.label(class="form-label") }}
            {{ form_helper.frequency_penalty(class="form-control", step="0.1", min="0", max="2", type="number") }}
            {% if form_helper.frequency_penalty.errors %}
                <div class="text-danger">
                    {{ form_helper.frequency_penalty.errors[0] }}
                </div>
            {% endif %}
        </div>
        <!-- Features -->
        <div class="col-md-12">
            <label class="form-label">üõ†Ô∏è T√≠nh nƒÉng:</label>
            <div class="form-check form-check-inline">
                {{ form_helper.autocomplete(class="form-check-input", id="autocomplete") }}
                {{ form_helper.autocomplete.label(class="form-check-label", for="autocomplete") }}
            </div>
            <div class="form-check form-check-inline">
                {{ form_helper.summarize(class="form-check-input", id="summarize") }}
                {{ form_helper.summarize.label(class="form-check-label", for="summarize") }}
            </div>
            <div class="form-check form-check-inline">
                {{ form_helper.translate(class="form-check-input", id="translate") }}
                {{ form_helper.translate.label(class="form-check-label", for="translate") }}
            </div>
            <div class="form-check form-check-inline">
                {{ form_helper.multi_chat(class="form-check-input", id="multi_chat") }}
                {{ form_helper.multi_chat.label(class="form-check-label", for="multi_chat") }}
            </div>
        </div>

        <div class="col-12 text-end">
            <button type="submit" class="btn btn-sm btn-primary">üíæ L∆∞u c·∫•u h√¨nh</button>
            <button type="button" id="btn-test-connection" class="btn btn-sm btn-success" data-action="test">üß™ Ki·ªÉm tra k·∫øt n·ªëi</button>
        </div>
    </form>
</div>
{% endblock %}

{% block js %}

<script>
const providerSelect = document.getElementById("provider");
const taskWrapper = document.getElementById("task-wrapper");

function toggleTaskSelect() {
    if (providerSelect.value === "huggingface") {
        taskWrapper.style.display = "block";
    } else {
        taskWrapper.style.display = "none";
    }
}
providerSelect.addEventListener("change", toggleTaskSelect);
document.addEventListener("DOMContentLoaded", toggleTaskSelect);

// Load model
document.addEventListener("DOMContentLoaded", function () {
    const tokenInput = document.getElementById("token");
    const providerSelect = document.getElementById("provider");
    const modelSelect = document.getElementById("model_name");
    const taskSelect = document.getElementById("task_type");

    async function fetchModels() {
        const token = tokenInput.value.trim();
        const provider = providerSelect.value.trim();
        const task = taskSelect?.value?.trim();

        if (!token || !provider) return;

        const payload = {
            token: token,
            provider: provider
        };

        if (provider === 'huggingface' && task) {
            payload.task = task;
        }

        try {
            const response = await axios.post("/admin/load-models", payload);
            const models = response.data.models || [];
            modelSelect.innerHTML = "";
            models.forEach((model) => {
                const option = document.createElement("option");
                option.value = model.id;
                option.textContent = model.label;
                modelSelect.appendChild(option);
            });
        } catch (error) {
            modelSelect.innerHTML = "";
            alert(error.response?.data?.error || "Kh√¥ng th·ªÉ load models. Ki·ªÉm tra API key v√† provider.");
        }
    }
    tokenInput.addEventListener("blur", fetchModels); // ho·∫∑c change
    providerSelect.addEventListener("change", fetchModels);
});

// Test k·∫øt n·ªëi
document.addEventListener("DOMContentLoaded", function () {
    const testBtn = document.getElementById("btn-test-connection");

    const tokenInput = document.getElementById("token");
    const providerSelect = document.getElementById('provider');

    testBtn.addEventListener("click", async function () {
        const apiKey = tokenInput.value.trim();
        const provider = providerSelect.value;

        if (!apiKey || !provider) {
            alert("Vui l√≤ng nh·∫≠p API key v√† ch·ªçn provider.");
            return;
        }

        try {
            const res = await axios.post("/admin/test-connection", {
                api_key: apiKey,
                provider: provider
            });
            alert(res.data.message || "K·∫øt n·ªëi th√†nh c√¥ng!");
        } catch (err) {
            alert(err.response?.data?.error || "K·∫øt n·ªëi th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i.");
        }
    });
});
</script>



{% endblock %}