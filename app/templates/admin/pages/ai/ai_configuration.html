{% extends 'admin/layout/base.html' %}
{% block title %}{{ page_title }}{% endblock %}
{% block content %}
{% include 'admin/components/breadcrumb.html' %}
<div class="container-fluid">
    <form class="row gy-3" method="post" action="{{ url_for('admin.ai_configuration') }}">
         {{ form.csrf_token }}
        <!-- API Token -->
        <div class="col-12">
            {{ form.token.label(class="form-label") }}
            {{ form.token(class="form-control", placeholder="Nh·∫≠p token API‚Ä¶") }}
        </div>
        <!-- Provider -->
        <div class="col-md-6">
            {{ form.provider.label(class="form-label") }}
            {{ form.provider(class="form-select") }}
        </div>
        <!-- Task (ch·ªâ hi·ªÉn th·ªã khi Hugging Face) -->
        <div class="col-md-6" id="task-wrapper" style="display:none">
            {{ form.task_type.label(class="form-label") }}
            {{ form.task_type(class="form-select") }}
        </div>
        <!-- Model -->
        <div class="col-md-6">
            {{ form.model_name.label(class="form-label") }}
            {{ form.model_name(class="form-select") }}
        </div>
        <div class="col-12 text-end">
            <button type="submit" class="btn btn-sm btn-primary">üíæ L∆∞u c·∫•u h√¨nh</button>
            <button type="button" id="btn-test-connection" class="btn btn-sm btn-success" data-action="test">üß™ Ki·ªÉm tra k·∫øt n·ªëi</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
class AiConfigurationManager {
    constructor() {
        this.tokenInput = document.getElementById("token");
        this.providerSelect = document.getElementById("provider");
        this.taskSelect = document.getElementById("task_type");
        this.modelSelect = document.getElementById("model_name");
        this.taskWrapper = document.getElementById("task-wrapper");
        this.testButton = document.getElementById("btn-test-connection");

        this.init();
    }

    init() {
        this.toggleTaskSelect();

        // G√°n s·ª± ki·ªán
        this.providerSelect.addEventListener("change", () => {
            this.toggleTaskSelect();
            this.fetchModels();
        });

        this.tokenInput.addEventListener("blur", () => this.fetchModels());
        this.taskSelect?.addEventListener("change", () => this.fetchModels());
        this.testButton.addEventListener("click", () => this.testConnection());
    }

    toggleTaskSelect() {
        const provider = this.providerSelect.value;
        if (provider === "huggingface") {
            this.taskWrapper.style.display = "block";
        } else {
            this.taskWrapper.style.display = "none";
        }
    }

    async fetchModels() {
        const token = this.tokenInput.value.trim();
        const provider = this.providerSelect.value.trim();
        const task = this.taskSelect?.value?.trim();

        if (!token || !provider) {
            Toastify({
                text: "Thi·∫øu token ho·∫∑c provider",
                duration: 4000,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                stopOnFocus: true
            }).showToast();
            return;
        }

        const payload = { token, provider };
        if (provider === "huggingface" && task) {
            payload.task = task;
        }

        try {
            const response = await axios.post("/admin/load-models", payload, {
                headers: {
                    'Content-Type': 'application/json',
                    "X-CSRFToken": this.getCsrfToken(),
                }
            });

            const models = response.data.models || [];
            this.modelSelect.innerHTML = "";
            models.forEach((model) => {
                const option = document.createElement("option");
                option.value = model.id;
                option.textContent = model.label;
                this.modelSelect.appendChild(option);
            });
        } catch (error) {
            Toastify({
                text: error.response?.data?.error || "Kh√¥ng th·ªÉ load models. Vui l√≤ng ki·ªÉm tra l·∫°i.",
                duration: 4000,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                stopOnFocus: true
            }).showToast();
        }
    }

    async testConnection() {
        const apiKey = this.tokenInput.value.trim();
        const provider = this.providerSelect.value.trim();

        if (!apiKey || !provider) {
            Toastify({
                text: "Vui l√≤ng nh·∫≠p API key v√† ch·ªçn provider.",
                duration: 4000,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                stopOnFocus: true
            }).showToast();
            return;
        }

        try {
            const response = await axios.post("/admin/test-connection", {
                api_key: apiKey,
                provider: provider
            }, {
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCsrfToken(),
                }
            });
            Toastify({
                text: response.data.message || "‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!",
                duration: 4000,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                stopOnFocus: true
            }).showToast();
        } catch (error) {
            console.error("‚ùå L·ªói ki·ªÉm tra k·∫øt n·ªëi:", error);
            Toastify({
                text: error.response?.data?.error || "K·∫øt n·ªëi th·∫•t b·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i.",
                duration: 4000,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)", // ƒë·ªè th·∫•t b·∫°i
                stopOnFocus: true
            }).showToast();
        }
    }

    getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") || "";
    }

}
document.addEventListener("DOMContentLoaded", function () {
    new AiConfigurationManager();
});

</script>
{% endblock %}